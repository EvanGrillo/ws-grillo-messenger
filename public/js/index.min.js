window.addEventListener("load",e=>{var t,n=document.cookie.split("; ").filter(e=>/user_name=*/.test(e))[0]||null;n&&n.split("=")[1]?(t=n.split("=")[1],t=prompt("Welcome back "+t+". Please reenter your name")):t=prompt("Please enter your name"),window.grillo_chat={user:t,msgs:[],fileList:[]},document.querySelector("#messenger").focus();var r=location.origin.replace(/^http/,"ws");const i=new WebSocket(r);function l(e){var t={msg:e,files:window.grillo_chat.fileList||null};i.send(JSON.stringify(t)),window.grillo_chat.fileList=[],window.grillo_chat.msgs.push(t),document.querySelectorAll(".file-preview").forEach(e=>{e.remove()}),document.querySelector("#messenger").innerHTML="",document.querySelector("#send").disabled=!0}function o(e){e.target.parentElement.remove(),window.grillo_chat.fileList.forEach((t,n)=>{t.name===e.target.parentElement.fileName&&window.grillo_chat.fileList.splice(n,1)})}i.addEventListener("open",function(e){let n={user:t||"Anonymous"};document.cookie="user_name="+t,window.grillo_chat.msgs.push(n),i.send(JSON.stringify(n))}),i.onclose=function(e){document.body.innerHTML="<h1 style='color:#ffffff;text-align:center;margin:50vh auto;'>Your connection closed</h1>"},i.onError=function(e){alert("Error: ",e)},i.addEventListener("message",function(e){var t=JSON.parse(e.data.replace(": undefined",""));window.grillo_chat.user_id=t._id;var n=document.createElement("div");n.className="msg",n.innerHTML=t.msg;var r=document.createElement("div");r.className="avatar",r.innerText=t.user.concat(": ",new Date(t.date).toLocaleTimeString());var i=document.querySelector("#msg-container"),l=document.createElement("div");if(l.style.margin="0 auto",l.style.width="100%",l.style.display="flex",l.style.justifyContent="center",t.files&&t.files.length&&(l.style.display="block",t.files.forEach(e=>{if(/image*/i.test(e.type)){var t=new Image;t.src=e.url,t.className="asset-img",l.append(t),n.prepend(l)}if(/audio*/i.test(e.type)){var r=document.createElement("audio");r.src=e.url,r.controls=!0,r.className="asset-audio",l.append(r),n.prepend(l)}if(/video*/i.test(e.type)){var i=document.createElement("video"),o=document.createElement("source");o.src=e.url,o.type=e.type,i.controls=!0,i.autoplay=!0,i.className="asset-video",i.style.width="100%",i.style.height="500px",i.appendChild(o),l.append(i),n.prepend(l)}if(/pdf*/i.test(e.type)||/doc*/i.test(e.type)||/text*/i.test(e.type)){var s=document.createElement("iframe");s.src=e.url,s.style.width="100%",s.style.height="500px",s.className="asset-iframe",n.prepend(s)}})),t.online||t.offline){var o=document.createElement("div"),s={display:"inline-block",width:"25px",height:"25px",borderRadius:"50%",marginRight:"0.5em"};Object.assign(o.style,s),t.online?o.style.background="#00ff00":o.style.background="#ff0000",s={display:"flex",alignItems:"center"},Object.assign(n.style,s),n.prepend(o)}else n.prepend(r);i.appendChild(n),i.scrollTop=i.scrollHeight}),document.querySelector("#file-input").addEventListener("change",e=>{Array.from(document.querySelector("#file-input").files).forEach(e=>{var t=document.createElement("div");t.innerHTML=e.name+"<br>"+e.type,t.className="file-preview",t.height=50,t.fileName=e.name;var n=document.createElement("span");n.innerHTML="âœ–",n.className="remove",n.addEventListener("click",o),t.prepend(n),document.querySelector("form").appendChild(t);var r=new FileReader;r.readAsDataURL(e),r.onload=function(){var t={type:e.type,url:r.result,name:e.name};window.grillo_chat.fileList.push(t),document.querySelector("#file-input").value="",document.querySelector("#send").disabled=!1},r.onerror=function(e){console.log("Error: ",e)}})}),document.querySelector("#messenger").addEventListener("input",e=>{e.preventDefault(),document.querySelector("#messenger").innerHTML?document.querySelector("#send").disabled=!1:document.querySelector("#send").disabled=!0}),document.querySelector("#messenger").addEventListener("keypress",e=>{var t=document.querySelector("#send").disabled;"Enter"!=e.key||e.shiftKey||t||(e.preventDefault(),l(messenger.innerHTML))}),document.querySelector("#send").addEventListener("click",e=>{let t=document.querySelector("#messenger");t.innerHTML&&(l(t.innerHTML),t.innerHTML="")})});